<script lang="ts">
  import { building } from '$app/environment'
  import { goto } from '$app/navigation'
  import { Card, diagrams } from '$lib'
  import {
    filter_tags,
    filtered_diagrams,
    search,
    tag_filter_mode,
  } from '$lib/stores'
  import { homepage, repository } from '$root/package.json'
  import Icon from '@iconify/svelte'
  import MultiSelect, { type ObjectOption } from 'svelte-multiselect'
  import { highlight_matches, RadioButtons } from 'svelte-zoo'

  let innerWidth: number = $state(0)

  const clamp = (num: number, min: number, max: number) =>
    Math.min(Math.max(num, min), max)

  const meta_description =
    `${diagrams.length} Diagrams on Physics, Chemistry, Computer Science, and Machine Learning`

  let active_diagram = $state(-1)

  function handle_keyup(event: KeyboardEvent) {
    if (event.key === `Enter` && active_diagram >= 0) {
      const site = diagrams[active_diagram]
      goto(site.slug)
    }
    const to = {
      // wrap around
      ArrowLeft: (active_diagram - 1 + diagrams.length) % diagrams.length,
      ArrowRight: (active_diagram + 1) % diagrams.length,
      Escape: -1,
    }[event.key]
    // if not arrow or escape key, return early for browser default behavior
    if (to === undefined) return
    if (to >= 0) active_diagram = to
    // keep active_idx in viewport
    const active = document.querySelector(`ul > li.active`)
    if (active) active.scrollIntoView()
  }
  let cols = $derived(clamp(Math.floor(innerWidth / 300), 1, 6))
  let tags = $derived(
    Object.entries(
      diagrams
        ?.flatMap((diagram) => diagram.tags)
        .reduce(
          (acc, el) => {
            acc[el] = (acc[el] ?? 0) + 1
            return acc
          },
          {} as Record<string, number>,
        ),
    )
      .filter(([, count]) => count > 2)
      .sort(([t1], [t2]) => t1.localeCompare(t2)),
  )
  $effect(() => {
    $filtered_diagrams = diagrams
      .filter((file) => {
        const searchTerms = $search?.toLowerCase().split(` `)
        const matches_search = searchTerms?.every((term) =>
          JSON.stringify(file).toLowerCase().includes(term)
        )

        let matches_tags = true
        if ($filter_tags.length > 0) {
          if ($tag_filter_mode === `or`) {
            matches_tags = $filter_tags.some((tag) => file.tags.includes(tag.label))
          } else if ($tag_filter_mode === `and`) {
            matches_tags = $filter_tags.every((tag) => file.tags.includes(tag.label))
          }
        }
        return matches_search && matches_tags
      })
      .sort((d1, d2) => {
        return d1.title.localeCompare(d2.title)
      })
  })
</script>

<svelte:head>
  <meta name="description" content={meta_description} />
  <meta property="og:title" content="Scientific Diagrams" />
  <meta property="og:description" content={meta_description} />
  <meta property="og:image" content="{homepage}/index-page-2021-08-04.png" />
  <meta property="og:image:alt" content="Scientific Diagrams index page" />
  <meta property="og:url" content={homepage} />
  <meta name="twitter:card" content="summary" />
</svelte:head>

<svelte:window bind:innerWidth onkeyup={handle_keyup} />

<h1>
  {diagrams.length} Scientific Diagrams
</h1>
<p>
  About
  {#each [`physics`, `chemistry`, `machine learning`] as tag, idx}
    {#if idx > 0},{/if}
    <button onclick={() => ($filter_tags = [{ label: tag, count: 0 }])}>
      {tag}
    </button>{/each},<br />
  <button onclick={() => ($filter_tags = [{ label: `cetz`, count: 0 }])}>
    {diagrams.filter((diagram) => diagram.code.typst).length}
  </button>
  of which in
  <a href="https://cetz-package.github.io/docs/">Cetz</a>
  (Typst) and
  <button onclick={() => ($filter_tags = [{ label: `tikz`, count: 0 }])}>
    {diagrams.filter((diagram) => diagram.code.tex).length}
  </button>
  in
  <a href="https://tikz.dev">TikZ</a> (LaTeX) diagrams.
</p>
<p>
  <Icon icon="octicon:law" inline />&nbsp;
  <a href="{repository}/blob/main/license">MIT licensed</a> (free to reuse)&ensp;
  <a href={repository}><Icon icon="octicon:mark-github" inline />&nbsp;Repo</a>
</p>
<p style="margin: auto; max-width: 40em">
  Have a TikZ image you'd like to share with attribution?
  <a href="{repository}/pulls">Submit a PR</a> with a <code>.tex</code> or
  <code>.typ</code>
  file and a corresponding metadata <code>.yml</code> file in the <code>assets/</code>
  directory to add it to this list. Also be sure to add yourself to the
  <a href="{repository}/blob/main/citation.cff"><code>citation.cff</code></a> file.
</p>

<div class="filters">
  <input name="Search" bind:value={$search} placeholder="Search..." />
  <MultiSelect
    options={tags.map(([label, count]) => ({ label, count }))}
    placeholder="Filter by tag..."
    bind:selected={$filter_tags}
  >
    {#snippet option({ option }: { option: ObjectOption })}
      <span style="display: flex; gap: 5pt; align-items: center">
        {option.label} <span style="flex: 1"></span> {option.count}
      </span>
    {/snippet}
  </MultiSelect>
  {#if $filter_tags?.length > 1}
    <RadioButtons bind:selected={$tag_filter_mode} options={[`and`, `or`]} />
  {/if}
</div>

{#if $search?.length || $filter_tags?.length}
  <p>{$filtered_diagrams.length} match{$filtered_diagrams.length != 1 ? `es` : ``}</p>
{/if}

{#if cols || building}
  <ul
    style:column-count={cols}
    style="column-gap: 1em"
    use:highlight_matches={{ query: $search, css_class: `highlight-match` }}
  >
    {#each $filtered_diagrams as item, idx (item.slug)}
      <li class:active={active_diagram == idx}>
        <Card {item} style="break-inside: avoid" />
      </li>
    {/each}
  </ul>
{/if}

<style>
  h1 {
    font-size: clamp(2rem, 2rem + 2vw, 3.5rem);
  }
  p {
    font-size: 2.2ex;
    line-height: 1.5;
  }
  ul {
    list-style: none;
    padding: 0;
  }
  ul > li {
    margin-bottom: 1em;
    border-radius: 1ex;
    overflow: hidden;
  }
  ul > li.active {
    border: 2px dashed;
  }
  input {
    outline: none;
    padding: 4px 1ex;
    border-radius: 3pt;
    color: inherit;
    background: black;
    border: 0.5px solid gray;
    font-size: 16px;
  }
  input::placeholder {
    color: var(--text-color);
  }
  div.filters {
    display: flex;
    flex-wrap: wrap;
    place-content: center;
    place-items: center;
    gap: 1ex 1em;
    margin: 2em;

    --sms-bg: black;
    --sms-max-width: 20em;
    --sms-selected-bg: rgba(255, 255, 255, 0.15);
    --sms-options-bg: #0f0422;
    --sms-border: 0.5px solid gray;
    --sms-li-active-bg: rgba(255, 255, 255, 0.15);
  }
  button {
    padding: 1pt 3pt;
    background-color: rgba(255, 255, 255, 0.15);
    font-size: inherit;
  }
</style>
